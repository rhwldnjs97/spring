<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="bbs">
 <select id="list" parameterType="Map" resultType="BbsDTO">
 	SELECT bbsno, wname, title, viewcnt, wdate, indent, filename, r                   
	from(                                                                                                   
		SELECT bbsno, wname, title, viewcnt, wdate, indent, filename, rownum as r                     
		from (                                                                                        
				SELECT bbsno, wname, title, viewcnt, to_char(wdate,'yyyy-mm-dd') as wdate, indent, filename 
				FROM bbs 
				<where>
				<if test="col=='wname'">
				wname LIKE '%'||#{word}||'%'
				</if>
				<if test="col=='content'">
				content LIKE '%'||#{word}||'%'
				</if>
				<if test="col=='title'">
				title LIKE '%'||#{word}||'%'
				</if>
				</where>
								ORDER BY grpno DESC, ansnum ) 
<![CDATA[	) where r>=#{sno} and r<=#{eno}  ]]>                                                                                         
 
 </select>
 <select id="total" parameterType="Map" resultType="int">
 	select count(*) from bbs
 	<where>
 	<choose>
 	<when test="col=='wname'">
 	wname LIKE '%'||#{word}||'%'
 	</when>
 	<when test="col=='title'">
 	title LIKE '%'||#{word}||'%'
 	</when>
 	<when test="col=='content'">
 	content LIKE '%'||#{word}||'%'
 	</when>
 	<otherwise>
 	wname LIKE '%'||#{word}||'%' or
 	title LIKE '%'||#{word}||'%' or
 	content LIKE '%'||#{word}||'%'
 	</otherwise>
 	</choose>
 	</where>
 </select>
 <delete id="delete" parameterType="int">
 	delete from bbs
 	where bbsno = #{bbsno}
 </delete>
 <select id="checkRefnum" parameterType="int" resultType="int">
 	select count(*) from bbs
 	where refnum = #{bbsno}
 </select>
 <select id="replyRead" parameterType="int" resultType="BbsDTO">
 	select bbsno, title, grpno, indent, ansnum, filename, filesize
		from bbs                                                
		where bbsno = #{bbsno}                                       
 
 </select>
 <update id="upAnsnum" parameterType="Map">
 	update bbs           
		set ansnum = ansnum+1 
		where grpno=#{grpno} and ansnum > ${ansnum}
 </update>0
 <insert id="replyCreate" parameterType="BbsDTO">
 	INSERT INTO bbs                                                                        
		(bbsno, wname, title, content, passwd, wdate, grpno, indent, ansnum, refnum, filename, filesize)
		VALUES((SELECT NVL(MAX(bbsno),0)+1 as max FROM bbs),                                      
		#{wname}, #{title}, #{content}, #{passwd}, sysdate, #{grpno}, #{indent}+1, #{ansnum}+1, #{bbsno},
		#{filename, jdbcType=VARCHAR}, #{filesize, jdbcType=INTEGER})                                                    
 </insert>

 <insert id="create" parameterType="BbsDTO">
	INSERT INTO bbs                                                 
		(bbsno, wname, title, content, passwd, wdate, grpno, filename, filesize)
		VALUES((SELECT NVL(MAX(bbsno),0)+1 as max FROM bbs),              
		#{wname}, #{title}, #{content}, #{passwd}, sysdate,                                            
 		(SELECT NVL(MAX(grpno),0)+1 as grpno FROM bbs), #{filename, jdbcType=VARCHAR}, #{filesize, jdbcType=INTEGER})                

</insert>


 
</mapper>